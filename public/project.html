<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVCKD MUSIC PROJECT</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'DungGeunMo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2204@1.0/DungGeunMo.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #000;
            color: #ff6600;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            overflow-x: hidden;
        }

        .user-info {
            position: fixed;
            top: 80px;
            left: 20px;
            font-size: 10px;
            color: #ff6600;
            z-index: 1001;
        }

        .user-role {
            color: #ffff00;
            margin-left: 10px;
        }

        .user-role.admin {
            color: #ff0000;
        }

        .navigation-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000;
            border-bottom: 2px solid #ff6600;
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            z-index: 1000;
            box-sizing: border-box;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 8px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #ff6600;
            color: #000;
            box-shadow: 0 0 10px #ff6600;
        }

        .nav-btn.active {
            background: #ff6600;
            color: #000;
        }

        .main-container {
            margin-top: 80px;
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        .project-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .project-header h1 {
            font-size: 24px;
            color: #ff6600;
            text-shadow: 0 0 5px #ff6600, 0 0 10px #ff6600, 0 0 20px #ff6600;
            margin-bottom: 10px;
        }

        .cursor {
            display: inline-block;
            animation: blink 1s step-start 0s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .project-subtitle {
            color: #fff;
            font-size: 10px;
            margin-bottom: 20px;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .project-card {
            border: 2px solid #ff6600;
            background: #000;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .project-card:hover {
            background: #111;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
            transform: translateY(-5px);
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff6600, transparent);
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .project-title {
            color: #ff6600;
            font-size: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-status {
            font-size: 8px;
            padding: 4px 8px;
            border: 1px solid;
            border-radius: 0;
        }

        .status-active {
            color: #00ff00;
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .status-development {
            color: #ffff00;
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.1);
        }

        .status-planning {
            color: #ff0000;
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .project-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 8px;
        }

        .project-participants {
            color: #ffff00;
        }

        .project-music-count {
            color: #00ff00;
        }

        .project-description {
            color: #fff;
            font-size: 9px;
            line-height: 14px;
            margin-bottom: 15px;
        }

        .project-tech {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tech-tag {
            background: #333;
            color: #ff6600;
            padding: 4px 8px;
            font-size: 7px;
            border: 1px solid #ff6600;
        }

        .project-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .project-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 6px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }

        .project-btn:hover {
            background: #ff6600;
            color: #000;
            box-shadow: 0 0 5px #ff6600;
        }

        .project-btn.join {
            color: #00ff00;
            border-color: #00ff00;
        }

        .project-btn.join:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 5px #00ff00;
        }

        .add-project-section {
            border: 2px dashed #ff6600;
            padding: 30px;
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 102, 0, 0.05);
        }

        .add-btn {
            background: #ff6600;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #ff6600;
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-terminal {
            background: #000;
            border: 2px solid #ff6600;
            padding: 40px;
            text-align: center;
            max-width: 90vw;
        }

        .login-title {
            color: #ff6600;
            font-size: 16px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #ff6600;
        }

        .login-subtitle {
            color: #fff;
            font-size: 10px;
            margin-bottom: 15px;
        }

        .login-input {
            background: transparent;
            border: 1px solid #ff6600;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 10px;
            margin-bottom: 30px;
            width: 250px;
            max-width: 80vw;
            text-align: center;
        }

        .login-btn {
            background: #ff6600;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #ff6600;
        }

        /* 음악룸 화면 - boombox.io 스타일 */
        .music-room {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1500;
            flex-direction: column;
        }

        .music-room-header {
            background: #000;
            border-bottom: 2px solid #ff6600;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .room-title {
            color: #ff6600;
            font-size: 12px;
        }

        .leave-btn {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 8px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
        }

        .music-content {
            flex: 1;
            display: flex;
            min-height: calc(100vh - 80px);
            flex-direction: column;
            overflow-y: auto;
        }

        /* boombox.io 스타일 - 간단한 트랙 정보 */
        .track-header-simple {
            background: #111;
            padding: 15px 20px;
            border-bottom: 1px solid #ff6600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-info-left {
            display: flex;
            flex-direction: column;
        }

        .track-title-simple {
            color: #ff6600;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .track-uploader-simple {
            color: #ffff00;
            font-size: 8px;
        }

        .track-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .download-btn {
            background: transparent;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 6px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 5px #00ff00;
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #666;
            border-color: #666;
        }

        .download-btn:disabled:hover {
            background: transparent;
            color: #666;
            box-shadow: none;
        }

        /* boombox.io 스타일 - 메인 웨이브폼 영역 */
        .waveform-main-area {
            background: #111;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 300px;
            margin-bottom: 20px;
            z-index: 1;
        }

        .waveform-container-main {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .waveform-canvas-main {
            width: 100%;
            height: 100%;
            display: none;
        }

        .waveform-loading-main {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6600;
            text-align: center;
            font-size: 8px;
        }

        .waveform-progress-main {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: transparent;
            width: 0%;
            transition: width 0.1s linear;
            pointer-events: none;
        }

        .playhead-main {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #9d4edd;
            left: 0%;
            transition: left 0.1s linear;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(157, 78, 221, 0.6);
            z-index: 10;
        }

        /* boombox.io 스타일 - 시간 표시 */
        .time-display {
            background: #111;
            color: #fff;
            font-size: 10px;
            padding: 10px 20px;
            border-top: 1px solid #ff6600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-current {
            color: #ff6600;
        }

        .time-separator {
            color: #666;
            margin: 0 5px;
        }

        .time-total {
            color: #fff;
        }

        /* boombox.io 스타일 - 간단한 컨트롤 */
        .simple-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px;
            background: #111;
            border-top: 1px solid #ff6600;
        }

        .play-btn-main {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ff6600;
            border: none;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .play-btn-main:hover {
            background: #ff8800;
            transform: scale(1.05);
        }

        .upload-btn-main {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn-main:hover {
            background: #ff6600;
            color: #000;
        }

        /* boombox.io 스타일 - 댓글 섹션 */
        .comments-section {
            background: #000;
            border-top: 2px solid #ff6600;
            padding: 10px;
            margin-top: 0;
            z-index: 1;
        }

        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
            position: relative;
            z-index: 2;
            background: #000;
            padding: 10px;
            border-top: 1px solid #ff6600;
        }

        .comment-time-indicator {
            color: #fff;
            font-size: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-time-indicator::before {
            content: "🕐";
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: 1px solid #ff6600;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            padding: 10px;
            min-width: 200px;
        }

        .comment-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 8px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .comment-btn:hover {
            background: #ff6600;
            color: #000;
        }

        .comment-btn.timestamp {
            color: #00ff00;
            border-color: #00ff00;
        }

        .comment-btn.timestamp:hover {
            background: #00ff00;
            color: #000;
        }

        .comment-btn.voice {
            color: #ff00ff;
            border-color: #ff00ff;
        }

        .comment-btn.voice:hover {
            background: #ff00ff;
            color: #000;
        }

        .comment-btn.send {
            color: #ffff00;
            border-color: #ffff00;
        }

        .comment-btn.send:hover {
            background: #ffff00;
            color: #000;
        }

        .comments-list {
            /* 스크롤 제거 - 자연스럽게 확장되도록 */
        }

        .comment-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #333;
            background: #111;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 7px;
        }

        .comment-user {
            color: #ffff00;
        }

        .comment-timestamp {
            color: #00ff00;
            cursor: pointer;
        }

        .comment-timestamp:hover {
            text-decoration: underline;
        }

        .comment-text {
            color: #fff;
            font-size: 8px;
            line-height: 12px;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .navigation-bar {
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-btn {
                font-size: 7px;
                padding: 6px 10px;
            }

            .project-header h1 {
                font-size: 18px;
            }

            .project-grid {
                grid-template-columns: 1fr;
            }

            .comment-input-area {
                flex-direction: column;
            }

            .comment-input {
                min-width: auto;
            }

            .simple-controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            .play-btn-main {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="user-info">
        USER: <span id="currentUser">GUEST</span>
        <span class="user-role" id="userRole">[GUEST]</span>
    </div>

    <div class="login-modal" id="loginModal">
        <div class="login-terminal">
            <div class="login-title">MUSIC ACCESS TERMINAL</div>
            <div class="login-subtitle">ENTER USER CREDENTIALS</div>
            <input type="text" class="login-input" id="usernameInput" placeholder="USERNAME" maxlength="20">
            <br>
            <button class="login-btn" id="joinButton">INITIALIZE CONNECTION</button>
        </div>
    </div>

    <div class="navigation-bar">
        <a href="/" class="nav-btn">CHAT ROOM</a>
        <a href="/project.html" class="nav-btn active">MUSIC</a>
        <a href="#" class="nav-btn">GALLERY</a>
        <a href="#" class="nav-btn">PROJECTS</a>
        <a href="#" class="nav-btn">ADMIN</a>
    </div>

    <div class="main-container" id="projectListView">
        <div class="project-header">
            <h1>VVCKD MUSIC ROOMS <span class="cursor">▌</span></h1>
            <div class="project-subtitle">ENHANCED COLLABORATIVE MUSIC WORKSPACE</div>
        </div>

        <div class="add-project-section" id="addProjectSection">
            <h3 style="color: #ff6600; margin-bottom: 20px;">CREATE MUSIC ROOM</h3>
            <button class="add-btn" onclick="createMusicRoom()">+ CREATE ROOM</button>
        </div>

        <div class="project-grid" id="projectGrid">
        </div>
    </div>

    <!-- boombox.io 스타일 음악룸 화면 -->
    <div class="music-room" id="musicRoomView">
        <div class="music-room-header">
            <div class="room-title" id="roomTitle">MUSIC ROOM</div>
            <button class="leave-btn" id="leaveRoomBtn">LEAVE ROOM</button>
        </div>
        <div class="music-content">
            <!-- 간단한 트랙 정보 (boombox.io 스타일) -->
            <div class="track-header-simple">
                <div class="track-info-left">
                    <div class="track-title-simple" id="currentTrackTitle">No track selected</div>
                    <div class="track-uploader-simple" id="currentTrackUploader">Upload a track to get started</div>
                </div>
                <div class="track-actions">
                    <button class="download-btn" id="downloadBtn" disabled>📥 DOWNLOAD</button>
                </div>
            </div>

            <!-- 메인 웨이브폼 영역 (boombox.io 스타일) -->
            <div class="waveform-main-area">
                <div class="waveform-container-main" id="waveformContainerMain">
                    <canvas class="waveform-canvas-main" id="waveformCanvasMain"></canvas>
                    <div class="waveform-progress-main" id="waveformProgressMain"></div>
                    <div class="playhead-main" id="playheadMain"></div>
                    <div class="waveform-loading-main" id="waveformLoadingMain">
                        🎵 Upload a track to see waveform<br>
                        Drag and drop or click upload button
                    </div>
                </div>

                <!-- 시간 표시 (웨이브폼 바로 아래) -->
                <div class="time-display" id="timeDisplay">
                    <div>
                        <span class="time-current" id="currentTime">00:00</span>
                        <span class="time-separator">/</span>
                        <span class="time-total" id="totalTime">00:00</span>
                    </div>
                </div>

                <!-- 간단한 컨트롤 (boombox.io 스타일) -->
                <div class="simple-controls">
                    <button class="play-btn-main" id="playBtnMain">▶</button>
                    <button class="upload-btn-main" id="uploadBtnMain">📎 UPLOAD MUSIC</button>
                </div>
            </div>

            <!-- 댓글 섹션 (웨이브폼 바로 아래, boombox.io 스타일) -->
            <div class="comments-section">
                <div class="comment-input-area">
                    <div class="comment-time-indicator" id="commentTimeIndicator">00:00</div>
                    <input type="text" class="comment-input" id="commentInput" placeholder="Add your comment here, mention users with @">
                    <button class="comment-btn voice" id="voiceBtn">🎤 VOICE</button>
                    <button class="comment-btn send" id="sendBtn">SEND</button>
                </div>
                <div class="comments-list" id="commentsList">
                    <!-- 시스템 댓글 제거 - 빈 상태로 시작 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 오디오 플레이어 (숨김) -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // 전역 변수
        let socket;
        let currentUser = '';
        let userRole = 'guest';
        let musicRooms = [];
        let currentPlaylist = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        let audioPlayer;
        let currentRoomId = null;
        let audioContextInstance = null;

        // DOM 요소 캐싱
        let currentUserSpan, userRoleSpan, loginModal, usernameInput, joinButton, projectListView, musicRoomView, projectGrid, leaveRoomBtn, playBtnMain, uploadBtnMain, commentInput, voiceBtn, sendBtn, commentsList, waveformContainerMain, waveformCanvasMain, waveformProgressMain, playheadMain, waveformLoadingMain, currentTrackTitle, currentTrackUploader, timeDisplay, currentTimeSpan, totalTimeSpan, downloadBtn, commentTimeIndicator;

        // 현재 업로드된 파일 정보
        let currentFile = null;
        let currentFileBlob = null;

        // 방 목록을 저장 (데모용으로만 사용)
        function saveMusicRoomsToStorage() {
            try {
                const roomsData = JSON.stringify(musicRooms);
                // 실제 운영 시에는 서버에 저장
                console.log('💾 Music rooms data prepared for storage:', roomsData);
            } catch (error) {
                console.error('❌ Failed to prepare rooms data:', error);
            }
        }

        // 방 목록 로드 (데모용으로만 사용)
        function loadMusicRoomsFromStorage() {
            try {
                // 실제 운영 시에는 서버에서 로드
                console.log('📂 Music rooms data would be loaded from server');
                return false;
            } catch (error) {
                console.error('❌ Failed to load rooms data:', error);
            }
            return false;
        }

        // 소켓 초기화 (실제 Socket.IO 사용)
        function initializeSocket() {
            // Socket.IO 스크립트 동적 로드
            if (typeof io === 'undefined') {
                const script = document.createElement('script');
                script.src = '/socket.io/socket.io.js';
                script.onload = function() {
                    connectSocket();
                };
                script.onerror = function() {
                    console.error('❌ Socket.IO 로드 실패, 더미 소켓 사용');
                    createDummySocket();
                };
                document.head.appendChild(script);
            } else {
                connectSocket();
            }
        }

        // 실제 Socket.IO 연결
        function connectSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('✅ Music: Connected to server');
                console.log('Socket ID:', socket.id);
            });

            socket.on('disconnect', () => {
                console.log('❌ Music: Disconnected from server');
            });

            // 음악 룸 관련 이벤트
            socket.on('music room list', function(rooms) {
                console.log('📋 Received music room list:', rooms);
                musicRooms = rooms;
                updateProjectGrid();
            });

            socket.on('music room created', function(room) {
                console.log('✅ Music room created:', room);
                // 방 생성 즉시 목록에 추가
                musicRooms.push(room);
                updateProjectGrid();
            });

            // 다른 사용자가 방을 만들었을 때 목록 업데이트
            socket.on('music room list update', function() {
                console.log('🔄 Music room list update requested');
                loadMusicRooms();
            });

            socket.on('music room join success', function(data) {
                console.log('✅ Successfully joined music room:', data);
                handleRoomJoinSuccess(data);
            });

            socket.on('music room join error', function(data) {
                console.log('❌ Failed to join music room:', data);
                alert('방 입장 실패: ' + data.message);
            });

            // 음악 룸 채팅 메시지
            socket.on('music chat message', function(data) {
                console.log('📨 Received music chat message:', data);
                if (data.roomId === currentRoomId) {
                    if (data.audioUrl) {
                        addVoiceCommentToDOM(data);
                    } else {
                        addCommentToDOM(data);
                    }
                }
            });

            console.log('🎵 Socket.IO initialized for music');
        }

        // 더미 소켓 (fallback)
        function createDummySocket() {
            const eventCallbacks = {};
            
            socket = {
                emit: function(event, data) {
                    console.log('📤 Dummy socket emit:', event, data);
                    
                    if (event === 'create music room') {
                        const newRoom = {
                            id: `room-${Date.now()}`,
                            name: data.roomName,
                            description: data.description || 'Collaborative music workspace',
                            genres: data.genres || ['Electronic', 'Hip-Hop', 'Rock'],
                            maxUsers: data.maxUsers || 10,
                            participants: 1,
                            musicCount: 0,
                            status: 'active'
                        };
                        musicRooms.push(newRoom);
                        updateProjectGrid(); // 즉시 UI 업데이트
                        console.log('✅ Room created successfully:', newRoom);
                    }
                    
                    if (event === 'get music room list') {
                        console.log('📋 Current rooms:', musicRooms);
                        if (eventCallbacks['music room list']) {
                            eventCallbacks['music room list'](musicRooms);
                        }
                    }
                },
                
                on: function(event, callback) {
                    console.log('👂 Dummy socket listener registered: ' + event);
                    eventCallbacks[event] = callback;
                    
                    if (event === 'music room list') {
                        setTimeout(function() {
                            console.log('📤 Sending room list:', musicRooms);
                            callback(musicRooms);
                        }, 100);
                    }
                }
            };
        }

        // 로그인 처리
        function login() {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                currentUserSpan.textContent = username;
                userRoleSpan.textContent = '[USER]';
                loginModal.style.display = 'none';
                
                console.log('✅ User logged in:', username);
                loadMusicRooms();
            } else {
                alert('사용자 이름을 입력해주세요.');
            }
        }

        // 음악 룸 생성 (실제 서버 연동)
        function createMusicRoom() {
            if (!currentUser || currentUser === 'GUEST') {
                alert('먼저 로그인해주세요.');
                return;
            }
            
            const roomName = prompt('음악 룸 이름을 입력하세요:');
            if (roomName) {
                const roomData = {
                    roomName: roomName,
                    description: 'Collaborative music workspace',
                    genres: ['Electronic', 'Hip-Hop', 'Rock'],
                    maxUsers: 10,
                    type: 'music' // 음악 룸임을 구분
                };
                
                socket.emit('create music room', roomData);
                console.log('🏠 Creating music room:', roomName);
            }
        }

        // 음악 룸 목록 로드 (실제 서버 연동)
        function loadMusicRooms() {
            console.log('📂 Loading music rooms from server');
            socket.emit('get music room list');
        }

        // 음악 룸 입장 (실제 서버 연동)
        function joinMusicRoom(roomId) {
            console.log('🚪 Joining music room:', roomId);
            socket.emit('join music room', { roomId: roomId });
        }

        // 음악 룸 입장 (서버 연동)
        function joinMusicRoom(roomId) {
            console.log('🚪 Joining music room:', roomId);
            socket.emit('join music room', { roomId: roomId });
        }

        // 음악 룸 입장 성공 처리
        function handleRoomJoinSuccess(data) {
            projectListView.style.display = 'none';
            musicRoomView.style.display = 'flex';
            
            // 현재 방 ID 저장
            currentRoomId = data.roomId;
            
            const room = musicRooms.find(r => r.id === data.roomId);
            if (room) {
                document.getElementById('roomTitle').textContent = room.name;
            }
            
            // 채팅 내용 복원
            restoreChatMessages(data.roomId);
        }

        // 채팅 내용을 저장 (데모용)
        function saveChatToStorage(roomId, chatData) {
            try {
                // 실제 운영 시에는 서버에 저장
                console.log('💾 Chat data prepared for storage:', roomId, chatData);
            } catch (error) {
                console.error('❌ Failed to prepare chat data:', error);
            }
        }

        // 채팅 내용 로드 (데모용)
        function loadChatFromStorage(roomId) {
            try {
                // 실제 운영 시에는 서버에서 로드
                console.log('📂 Chat data would be loaded from server for room:', roomId);
                return [];
            } catch (error) {
                console.error('❌ Failed to load chat data:', error);
            }
            return [];
        }

        // 채팅 목록 복원
        function restoreChatMessages(roomId) {
            // 기존 모든 메시지 제거 (시스템 메시지 포함)
            commentsList.innerHTML = '';
            
            const savedChats = loadChatFromStorage(roomId);
            // 저장된 채팅 복원
            savedChats.forEach(chat => {
                if (chat.audioUrl) {
                    addVoiceCommentToDOM(chat);
                } else {
                    addCommentToDOM(chat);
                }
            });
            
            if (savedChats.length > 0) {
                console.log('🔄 Restored', savedChats.length, 'chat messages for room:', roomId);
            }
        }

        // 음악 룸 나가기 (서버 연동)
        function leaveMusicRoom() {
            console.log('🚪 Leaving music room');
            
            if (currentRoomId) {
                socket.emit('leave music room', { roomId: currentRoomId });
                currentRoomId = null;
            }
            
            musicRoomView.style.display = 'none';
            projectListView.style.display = 'block';
            
            // 오디오 정지
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
                if (playBtnMain) {
                    playBtnMain.textContent = '▶';
                }
            }
            
            // 파일 정보 초기화
            currentFile = null;
            currentFileBlob = null;
            
            // 다운로드 버튼 비활성화
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.textContent = '📥 DOWNLOAD';
            }
            
            // 오디오 컨텍스트 정리
            if (audioContextInstance) {
                audioContextInstance.close();
                audioContextInstance = null;
            }
            
            // 방 목록 새로고침
            loadMusicRooms();
        }

        // 댓글 전송 (서버 연동)
        function sendComment() {
            const message = commentInput.value.trim();
            if (message && currentUser && currentUser !== 'GUEST' && currentRoomId) {
                const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
                
                const commentData = {
                    roomId: currentRoomId,
                    user: currentUser,
                    message: message,
                    timestamp: timestamp,
                    time: new Date().toISOString()
                };
                
                socket.emit('music chat message', commentData);
                commentInput.value = '';
                console.log('💬 Comment sent:', commentData);
            } else if (!currentUser || currentUser === 'GUEST') {
                alert('로그인 후 댓글을 작성할 수 있습니다.');
            }
        }

        // 음성 메시지 전송 (서버 연동)
        function sendVoiceMessage(audioBlob) {
            if (!currentRoomId) return;
            
            const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // 음성 메시지를 서버로 전송
            const voiceData = {
                roomId: currentRoomId,
                user: currentUser,
                timestamp: timestamp,
                audioUrl: audioUrl, // 실제 구현에서는 서버에 업로드 필요
                time: new Date().toISOString()
            };
            
            socket.emit('music voice message', voiceData);
            console.log('🎤 Voice message sent:', voiceData);
        }

        // 댓글 추가
        function addComment(user, message, timestamp) {
            const chatData = {
                user: user,
                message: message,
                timestamp: timestamp,
                time: new Date().toISOString()
            };
            
            // 저장
            if (currentRoomId) {
                saveChatToStorage(currentRoomId, chatData);
            }
            
            // DOM에 추가
            addCommentToDOM(chatData);
        }

        // DOM에 댓글 추가 (복원용)
        function addCommentToDOM(chatData) {
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <span class="comment-user">${chatData.user}</span>
                    <span class="comment-timestamp" onclick="seekToTime(${chatData.timestamp})">[${formatTime(chatData.timestamp)}]</span>
                </div>
                <div class="comment-text">${chatData.message}</div>
            `;
            
            commentsList.appendChild(commentItem);
            // 스크롤 제거 - 자연스럽게 확장되도록
        }

        // DOM에 음성 댓글 추가 (복원용)
        function addVoiceCommentToDOM(chatData) {
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item voice-comment';
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <span class="comment-user">${chatData.user}</span>
                    <span class="comment-timestamp" onclick="seekToTime(${chatData.timestamp})">[${formatTime(chatData.timestamp)}]</span>
                </div>
                <div class="voice-message">
                    🎤 Voice Message
                    <audio controls style="width: 100%; margin-top: 5px;">
                        <source src="${chatData.audioUrl}" type="audio/wav">
                    </audio>
                </div>
            `;
            
            commentsList.appendChild(commentItem);
            // 스크롤 제거 - 자연스럽게 확장되도록
        }

        // 타임스탬프 추가 (제거됨)
        // function addTimestamp() {
        //     if (!currentUser || currentUser === 'GUEST') {
        //         alert('로그인 후 타임스탬프를 추가할 수 있습니다.');
        //         return;
        //     }
        //     const currentTime = audioPlayer ? audioPlayer.currentTime : 0;
        //     const message = `[Timestamp at ${formatTime(currentTime)}]`;
        //     addComment(currentUser, message, currentTime);
        // }

        // 시간 포맷 함수
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // 특정 시간으로 이동
        function seekToTime(time) {
            if (audioPlayer && audioPlayer.duration) {
                audioPlayer.currentTime = time;
                console.log('🎵 Seeked to: ' + formatTime(time));
            }
        }

        // 웨이브폼 클릭 처리
        function handleWaveformClick(event) {
            if (audioPlayer && audioPlayer.duration) {
                const rect = waveformContainerMain.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const newTime = percentage * audioPlayer.duration;
                seekToTime(newTime);
            }
        }

        // 오디오 플레이어 업데이트
        function updateAudioPlayer() {
            if (audioPlayer && !isNaN(audioPlayer.currentTime)) {
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration || 0;
                
                // 시간 표시 업데이트
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = formatTime(currentTime);
                }
                if (totalTimeSpan && duration > 0) {
                    totalTimeSpan.textContent = formatTime(duration);
                }
                
                // 댓글 입력 영역 시간 표시 업데이트
                if (commentTimeIndicator) {
                    commentTimeIndicator.textContent = formatTime(currentTime);
                }
                
                // 웨이브폼 진행률 업데이트
                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    
                    // 웨이브폼 색상 업데이트
                    updateWaveformProgress(progressPercent);
                    
                    // 플레이헤드 위치 업데이트
                    if (playheadMain) {
                        playheadMain.style.left = `${progressPercent}%`;
                    }
                }
            }
        }

        // 파일 업로드 처리
        function handleFileUpload(file) {
            if (file && file.type.startsWith('audio/')) {
                // 현재 파일 정보 저장
                currentFile = file;
                currentFileBlob = file;
                
                const fileUrl = URL.createObjectURL(file);
                audioPlayer.src = fileUrl;
                
                currentTrackTitle.textContent = file.name;
                currentTrackUploader.textContent = `Uploaded by: ${currentUser}`;
                
                // 다운로드 버튼 활성화
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = '📥 DOWNLOAD';
                }
                
                // 업로드 후 캔버스 표시 및 로딩 메시지 숨김
                waveformLoadingMain.style.display = 'none';
                waveformCanvasMain.style.display = 'block';
                
                // 시간 표시 초기화
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = '00:00';
                }
                if (totalTimeSpan) {
                    totalTimeSpan.textContent = '00:00';
                }
                
                // 오디오 메타데이터 로드 시 총 시간 업데이트
                audioPlayer.addEventListener('loadedmetadata', function() {
                    if (totalTimeSpan) {
                        totalTimeSpan.textContent = formatTime(audioPlayer.duration);
                    }
                });
                
                // 웨이브폼 생성
                generateWaveform(file);
                
                console.log('✅ Audio file loaded:', file.name);
            }
        }

        // 파일 다운로드 처리
        function downloadCurrentFile() {
            if (!currentFile || !currentFileBlob) {
                alert('다운로드할 파일이 없습니다.');
                return;
            }
            
            try {
                // 다운로드 링크 생성
                const downloadUrl = URL.createObjectURL(currentFileBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.download = currentFile.name;
                downloadLink.style.display = 'none';
                
                // 다운로드 실행
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // URL 정리
                setTimeout(() => {
                    URL.revokeObjectURL(downloadUrl);
                }, 100);
                
                console.log('✅ File download initiated:', currentFile.name);
            } catch (error) {
                console.error('❌ Download failed:', error);
                alert('다운로드에 실패했습니다.');
            }
        }

        // 웨이브폼 생성 함수
        function generateWaveform(file) {
            try {
                audioContextInstance = new (window.AudioContext || window.webkitAudioContext)();
                const canvas = waveformCanvasMain;
                const ctx = canvas.getContext('2d');
                
                // 캔버스 크기 설정
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    audioContextInstance.decodeAudioData(e.target.result)
                        .then((audioBuffer) => {
                            drawWaveform(ctx, audioBuffer, canvas.width, canvas.height);
                        })
                        .catch((error) => {
                            console.error('❌ Error decoding audio:', error);
                            // 에러 시 더미 웨이브폼 표시
                            drawDummyWaveform(ctx, canvas.width, canvas.height);
                        });
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('❌ Error creating audio context:', error);
                // 오디오 컨텍스트 생성 실패 시 더미 웨이브폼 표시
                const canvas = waveformCanvasMain;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                drawDummyWaveform(ctx, canvas.width, canvas.height);
            }
        }

        // 웨이브폼 데이터 저장용 변수
        let waveformData = null;

        // 실제 웨이브폼 그리기 (boombox.io 스타일)
        function drawWaveform(ctx, audioBuffer, width, height) {
            const data = audioBuffer.getChannelData(0);
            const step = Math.ceil(data.length / width);
            const amp = height / 2;
            
            // 웨이브폼 데이터 저장
            waveformData = {
                data: data,
                step: step,
                amp: amp,
                width: width,
                height: height
            };
            
            // 배경을 검은색으로 설정
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // 웨이브폼 그리기 - 초기에는 모두 회색
            drawWaveformWithProgress(ctx, 0);
            
            console.log('✅ boombox.io style waveform generated');
        }

        // 진행률에 따라 웨이브폼 그리기
        function drawWaveformWithProgress(ctx, progressPercent) {
            if (!waveformData) return;
            
            const { data, step, amp, width, height } = waveformData;
            const centerY = height / 2;
            const progressPixel = (progressPercent / 100) * width;
            
            // 배경 지우기
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // 웨이브폼 그리기
            for (let i = 0; i < width; i += 1) {
                let min = 1.0;
                let max = -1.0;
                
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                
                // 바 높이 계산
                const barHeight = Math.max(1, Math.abs(max - min) * amp * 0.9);
                
                // 재생 위치에 따른 색상 결정
                if (i <= progressPixel) {
                    ctx.fillStyle = '#00ff00'; // 재생된 부분 - 녹색
                } else {
                    ctx.fillStyle = '#666'; // 아직 재생되지 않은 부분 - 회색
                }
                
                // 웨이브폼 바 그리기
                ctx.fillRect(i, centerY - barHeight/2, 1, barHeight);
            }
        }

        // 진행률에 따라 웨이브폼 색상 업데이트
        function updateWaveformProgress(progressPercent) {
            const canvas = waveformCanvasMain;
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) return;
            
            // 웨이브폼을 진행률에 따라 다시 그리기
            drawWaveformWithProgress(ctx, progressPercent);
        }

        // 더미 웨이브폼 그리기 (boombox.io 스타일)
        function drawDummyWaveform(ctx, width, height) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            const centerY = height / 2;
            
            // 더미 웨이브폼 데이터 생성
            const dummyData = [];
            for (let i = 0; i < width; i += 2) {
                dummyData.push(Math.random() * 0.8 - 0.4);
            }
            
            // 웨이브폼 데이터 저장
            waveformData = {
                isDummy: true,
                dummyData: dummyData,
                width: width,
                height: height
            };
            
            // boombox.io 스타일의 더미 웨이브폼 - 회색으로 시작
            for (let i = 0; i < width; i += 2) {
                const barHeight = Math.random() * height * 0.6 + 4;
                
                // 기본 회색 웨이브폼
                ctx.fillStyle = '#666';
                ctx.fillRect(i, centerY - barHeight/2, 1, barHeight);
            }
            
            console.log('✅ boombox.io style dummy waveform generated');
        }

        // 프로젝트 그리드 업데이트
        function updateProjectGrid() {
            if (musicRooms.length === 0) {
                projectGrid.innerHTML = `
                    <div class="project-card" style="text-align: center; padding: 40px;">
                        <div style="color: #888; margin-bottom: 20px;">No rooms available</div>
                        <div style="color: #666; font-size: 8px;">Create the first music room to get started!</div>
                        <button class="project-btn" disabled>EMPTY</button>
                    </div>
                `;
                return;
            }

            projectGrid.innerHTML = '';
            
            musicRooms.forEach(function(room) {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                
                projectCard.innerHTML = `
                    <div class="project-title">
                        ${room.name}
                        <span class="project-status status-${room.status}">${room.status.toUpperCase()}</span>
                    </div>
                    <div class="project-info">
                        <span class="project-participants">👥 ${room.participants} users</span>
                        <span class="project-music-count">🎵 ${room.musicCount} tracks</span>
                    </div>
                    <div class="project-description">${room.description}</div>
                    <div class="project-tech">
                        <span class="tech-tag">AUDIO</span>
                        <span class="tech-tag">COLLABORATION</span>
                        <span class="tech-tag">REAL-TIME</span>
                        <span class="tech-tag">VOICE MEMO</span>
                    </div>
                    <div class="project-links">
                        <button class="project-btn join" onclick="joinMusicRoom('${room.id}')">JOIN ROOM</button>
                        <button class="project-btn" onclick="viewRoomInfo('${room.id}')">VIEW INFO</button>
                    </div>
                `;
                
                projectGrid.appendChild(projectCard);
            });
        }

        // 룸 정보 보기
        function viewRoomInfo(roomId) {
            const room = musicRooms.find(r => r.id === roomId);
            if (room) {
                alert(`Room: ${room.name}\nDescription: ${room.description}\nParticipants: ${room.participants}/${room.maxUsers}\nTracks: ${room.musicCount}`);
            }
        }

        // 음성 녹음 관련 변수
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        // 음성 녹음 시작
        function startVoiceRecording() {
            if (!currentUser || currentUser === 'GUEST') {
                alert('로그인 후 음성 메시지를 녹음할 수 있습니다.');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    // 녹음 데이터 수집
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    // 녹음 완료 시 댓글로 전송
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        sendVoiceMessage(blob);
                        
                        // 스트림 정리
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.textContent = '⏹️ STOP';
                    voiceBtn.style.background = '#ff0000';
                    console.log('🎤 Voice recording started');
                })
                .catch(function(error) {
                    console.error('❌ Voice recording error:', error);
                    alert('마이크 접근 권한이 필요합니다.');
                });
        }

        // 음성 녹음 중지
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.textContent = '🎤 VOICE';
                voiceBtn.style.background = 'transparent';
                console.log('🎤 Voice recording stopped');
            }
        }
        
        // 음성 메시지 전송
        function sendVoiceMessage(audioBlob) {
            const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // 음성 메시지를 댓글로 추가
            const comment = {
                user: currentUser,
                timestamp: timestamp,
                text: '[음성 메시지]',
                audioUrl: audioUrl,
                time: new Date().toLocaleTimeString()
            };
            
            addVoiceCommentToDOM(comment);
            console.log('🎤 Voice message sent successfully');
        }

        // 초기화 함수
        function initializeApp() {
            console.log('🎵 VVCKD Music System initialized');
            
            // DOM 요소들 초기화
            currentUserSpan = document.getElementById('currentUser');
            userRoleSpan = document.getElementById('userRole');
            loginModal = document.getElementById('loginModal');
            usernameInput = document.getElementById('usernameInput');
            joinButton = document.getElementById('joinButton');
            projectListView = document.getElementById('projectListView');
            musicRoomView = document.getElementById('musicRoomView');
            projectGrid = document.getElementById('projectGrid');
            leaveRoomBtn = document.getElementById('leaveRoomBtn');
            playBtnMain = document.getElementById('playBtnMain');
            uploadBtnMain = document.getElementById('uploadBtnMain');
            commentInput = document.getElementById('commentInput');
            voiceBtn = document.getElementById('voiceBtn');
            sendBtn = document.getElementById('sendBtn');
            commentsList = document.getElementById('commentsList');
            waveformContainerMain = document.getElementById('waveformContainerMain');
            waveformCanvasMain = document.getElementById('waveformCanvasMain');
            waveformProgressMain = document.getElementById('waveformProgressMain');
            playheadMain = document.getElementById('playheadMain');
            waveformLoadingMain = document.getElementById('waveformLoadingMain');
            currentTrackTitle = document.getElementById('currentTrackTitle');
            currentTrackUploader = document.getElementById('currentTrackUploader');
            audioPlayer = document.getElementById('audioPlayer');
            timeDisplay = document.getElementById('timeDisplay');
            currentTimeSpan = document.getElementById('currentTime');
            totalTimeSpan = document.getElementById('totalTime');
            downloadBtn = document.getElementById('downloadBtn');
            commentTimeIndicator = document.getElementById('commentTimeIndicator');

            // 소켓 초기화
            initializeSocket();

            // 소켓 이벤트 리스너 (실제 연결 시에만 등록)
            if (typeof io !== 'undefined') {
                // 음악 룸 입장 성공 시 UI 업데이트
                socket.on('music room join success', handleRoomJoinSuccess);
            } else {
                // 더미 소켓 이벤트 리스너
                socket.on('music room list', function(rooms) {
                    console.log('📋 Received room list:', rooms);
                    musicRooms = rooms;
                    updateProjectGrid();
                });
            }

            // 이벤트 리스너 등록
            setupEventListeners();

            // 로그인 모달 표시
            if (loginModal) {
                loginModal.style.display = 'flex';
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 로그인 이벤트
            if (joinButton) {
                joinButton.addEventListener('click', login);
            }
            
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // 룸 나가기 이벤트
            if (leaveRoomBtn) {
                leaveRoomBtn.addEventListener('click', leaveMusicRoom);
            }
            
            // 재생 버튼 이벤트
            if (playBtnMain) {
                playBtnMain.addEventListener('click', function() {
                    if (audioPlayer && audioPlayer.src) {
                        if (isPlaying) {
                            audioPlayer.pause();
                            this.textContent = '▶';
                            isPlaying = false;
                        } else {
                            audioPlayer.play();
                            this.textContent = '⏸';
                            isPlaying = true;
                        }
                    }
                });
            }

            // 파일 업로드 버튼 클릭 처리
            if (uploadBtnMain) {
                uploadBtnMain.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'audio/*';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            handleFileUpload(file);
                        }
                    };
                    input.click();
                });
            }

            // 오디오 플레이어 시간 업데이트 이벤트
            if (audioPlayer) {
                audioPlayer.addEventListener('timeupdate', updateAudioPlayer);
                audioPlayer.addEventListener('ended', () => {
                    isPlaying = false;
                    if (playBtnMain) {
                        playBtnMain.textContent = '▶';
                    }
                });
            }

            // 웨이브폼 클릭 시 탐색
            if (waveformContainerMain) {
                waveformContainerMain.addEventListener('click', handleWaveformClick);
                
                // 파일 드래그 앤 드롭 처리
                waveformContainerMain.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });

                waveformContainerMain.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileUpload(files[0]);
                    }
                });
            }

            // 다운로드 버튼 이벤트
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadCurrentFile);
            }

            // 댓글 관련 이벤트 리스너
            if (sendBtn) {
                sendBtn.addEventListener('click', sendComment);
            }

            if (commentInput) {
                commentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendComment();
                    }
                });
            }

            if (voiceBtn) {
                voiceBtn.addEventListener('click', function() {
                    if (isRecording) {
                        stopVoiceRecording();
                    } else {
                        startVoiceRecording();
                    }
                });
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
