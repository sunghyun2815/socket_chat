<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VVCKD MUSIC PROJECT</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'DungGeunMo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2204@1.0/DungGeunMo.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #000;
            color: #ff6600;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            overflow-x: hidden;
        }

        .user-info {
            position: fixed;
            top: 80px;
            left: 20px;
            font-size: 10px;
            color: #ff6600;
            z-index: 1001;
        }

        .user-role {
            color: #ffff00;
            margin-left: 10px;
        }

        .user-role.admin {
            color: #ff0000;
        }

        .navigation-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #000;
            border-bottom: 2px solid #ff6600;
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            z-index: 1000;
            box-sizing: border-box;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 8px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }

        .nav-btn:hover {
            background: #ff6600;
            color: #000;
            box-shadow: 0 0 10px #ff6600;
        }

        .nav-btn.active {
            background: #ff6600;
            color: #000;
        }

        .main-container {
            margin-top: 80px;
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        .project-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .project-header h1 {
            font-size: 24px;
            color: #ff6600;
            text-shadow: 0 0 5px #ff6600, 0 0 10px #ff6600, 0 0 20px #ff6600;
            margin-bottom: 10px;
        }

        .cursor {
            display: inline-block;
            animation: blink 1s step-start 0s infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .project-subtitle {
            color: #fff;
            font-size: 10px;
            margin-bottom: 20px;
        }

        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .project-card {
            border: 2px solid #ff6600;
            background: #000;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .project-card:hover {
            background: #111;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
            transform: translateY(-5px);
        }

        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff6600, transparent);
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .project-title {
            color: #ff6600;
            font-size: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-status {
            font-size: 8px;
            padding: 4px 8px;
            border: 1px solid;
            border-radius: 0;
        }

        .status-active {
            color: #00ff00;
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .status-development {
            color: #ffff00;
            border-color: #ffff00;
            background: rgba(255, 255, 0, 0.1);
        }

        .status-planning {
            color: #ff0000;
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .project-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 8px;
        }

        .project-participants {
            color: #ffff00;
        }

        .project-music-count {
            color: #00ff00;
        }

        .project-description {
            color: #fff;
            font-size: 9px;
            line-height: 14px;
            margin-bottom: 15px;
        }

        .project-tech {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tech-tag {
            background: #333;
            color: #ff6600;
            padding: 4px 8px;
            font-size: 7px;
            border: 1px solid #ff6600;
        }

        .project-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .project-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 6px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }

        .project-btn:hover {
            background: #ff6600;
            color: #000;
            box-shadow: 0 0 5px #ff6600;
        }

        .project-btn.join {
            color: #00ff00;
            border-color: #00ff00;
        }

        .project-btn.join:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 5px #00ff00;
        }

        .add-project-section {
            border: 2px dashed #ff6600;
            padding: 30px;
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 102, 0, 0.05);
        }

        .add-btn {
            background: #ff6600;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #ff6600;
        }

        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-terminal {
            background: #000;
            border: 2px solid #ff6600;
            padding: 40px;
            text-align: center;
            max-width: 90vw;
        }

        .login-title {
            color: #ff6600;
            font-size: 16px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #ff6600;
        }

        .login-subtitle {
            color: #fff;
            font-size: 10px;
            margin-bottom: 15px;
        }

        .login-input {
            background: transparent;
            border: 1px solid #ff6600;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 10px;
            margin-bottom: 30px;
            width: 250px;
            max-width: 80vw;
            text-align: center;
        }

        .login-btn {
            background: #ff6600;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #ff6600;
        }

        /* ìŒì•…ë£¸ í™”ë©´ - boombox.io ìŠ¤íƒ€ì¼ */
        .music-room {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1500;
            flex-direction: column;
        }

        .music-room-header {
            background: #000;
            border-bottom: 2px solid #ff6600;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .room-title {
            color: #ff6600;
            font-size: 12px;
        }

        .leave-btn {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 8px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
        }

        .music-content {
            flex: 1;
            display: flex;
            min-height: calc(100vh - 80px);
            flex-direction: column;
            overflow-y: auto;
        }

        /* boombox.io ìŠ¤íƒ€ì¼ - ê°„ë‹¨í•œ íŠ¸ë™ ì •ë³´ */
        .track-header-simple {
            background: #111;
            padding: 15px 20px;
            border-bottom: 1px solid #ff6600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-info-left {
            display: flex;
            flex-direction: column;
        }

        .track-title-simple {
            color: #ff6600;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .track-uploader-simple {
            color: #ffff00;
            font-size: 8px;
        }

        .track-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .download-btn {
            background: transparent;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 6px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 5px #00ff00;
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #666;
            border-color: #666;
        }

        .download-btn:disabled:hover {
            background: transparent;
            color: #666;
            box-shadow: none;
        }

        /* boombox.io ìŠ¤íƒ€ì¼ - ë©”ì¸ ì›¨ì´ë¸Œí¼ ì˜ì—­ */
        .waveform-main-area {
            background: #111;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 300px;
            margin-bottom: 20px;
            z-index: 1;
        }

        .waveform-container-main {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        .waveform-canvas-main {
            width: 100%;
            height: 100%;
            display: none;
        }

        .waveform-loading-main {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6600;
            text-align: center;
            font-size: 8px;
        }

        .waveform-progress-main {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: transparent;
            width: 0%;
            transition: width 0.1s linear;
            pointer-events: none;
        }

        .playhead-main {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #9d4edd;
            left: 0%;
            transition: left 0.1s linear;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(157, 78, 221, 0.6);
            z-index: 10;
        }

        /* boombox.io ìŠ¤íƒ€ì¼ - ì‹œê°„ í‘œì‹œ */
        .time-display {
            background: #111;
            color: #fff;
            font-size: 10px;
            padding: 10px 20px;
            border-top: 1px solid #ff6600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-current {
            color: #ff6600;
        }

        .time-separator {
            color: #666;
            margin: 0 5px;
        }

        .time-total {
            color: #fff;
        }

        /* boombox.io ìŠ¤íƒ€ì¼ - ê°„ë‹¨í•œ ì»¨íŠ¸ë¡¤ */
        .simple-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px;
            background: #111;
            border-top: 1px solid #ff6600;
        }

        .play-btn-main {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ff6600;
            border: none;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .play-btn-main:hover {
            background: #ff8800;
            transform: scale(1.05);
        }

        .upload-btn-main {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn-main:hover {
            background: #ff6600;
            color: #000;
        }

        /* boombox.io ìŠ¤íƒ€ì¼ - ëŒ“ê¸€ ì„¹ì…˜ */
        .comments-section {
            background: #000;
            border-top: 2px solid #ff6600;
            padding: 10px;
            margin-top: 0;
            z-index: 1;
        }

        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
            position: relative;
            z-index: 2;
            background: #000;
            padding: 10px;
            border-top: 1px solid #ff6600;
        }

        .comment-time-indicator {
            color: #fff;
            font-size: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-time-indicator::before {
            content: "ğŸ•";
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: 1px solid #ff6600;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 8px;
            padding: 10px;
            min-width: 200px;
        }

        .comment-btn {
            background: transparent;
            color: #ff6600;
            border: 1px solid #ff6600;
            padding: 8px 12px;
            font-family: 'Press Start 2P', cursive;
            font-size: 7px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .comment-btn:hover {
            background: #ff6600;
            color: #000;
        }

        .comment-btn.timestamp {
            color: #00ff00;
            border-color: #00ff00;
        }

        .comment-btn.timestamp:hover {
            background: #00ff00;
            color: #000;
        }

        .comment-btn.voice {
            color: #ff00ff;
            border-color: #ff00ff;
        }

        .comment-btn.voice:hover {
            background: #ff00ff;
            color: #000;
        }

        .comment-btn.send {
            color: #ffff00;
            border-color: #ffff00;
        }

        .comment-btn.send:hover {
            background: #ffff00;
            color: #000;
        }

        .comments-list {
            /* ìŠ¤í¬ë¡¤ ì œê±° - ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥ë˜ë„ë¡ */
        }

        .comment-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #333;
            background: #111;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 7px;
        }

        .comment-user {
            color: #ffff00;
        }

        .comment-timestamp {
            color: #00ff00;
            cursor: pointer;
        }

        .comment-timestamp:hover {
            text-decoration: underline;
        }

        .comment-text {
            color: #fff;
            font-size: 8px;
            line-height: 12px;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .navigation-bar {
                flex-wrap: wrap;
                gap: 10px;
            }

            .nav-btn {
                font-size: 7px;
                padding: 6px 10px;
            }

            .project-header h1 {
                font-size: 18px;
            }

            .project-grid {
                grid-template-columns: 1fr;
            }

            .comment-input-area {
                flex-direction: column;
            }

            .comment-input {
                min-width: auto;
            }

            .simple-controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            .play-btn-main {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="user-info">
        USER: <span id="currentUser">GUEST</span>
        <span class="user-role" id="userRole">[GUEST]</span>
    </div>

    <div class="login-modal" id="loginModal">
        <div class="login-terminal">
            <div class="login-title">MUSIC ACCESS TERMINAL</div>
            <div class="login-subtitle">ENTER USER CREDENTIALS</div>
            <input type="text" class="login-input" id="usernameInput" placeholder="USERNAME" maxlength="20">
            <br>
            <button class="login-btn" id="joinButton">INITIALIZE CONNECTION</button>
        </div>
    </div>

    <div class="navigation-bar">
        <a href="/" class="nav-btn">CHAT ROOM</a>
        <a href="/project.html" class="nav-btn active">MUSIC</a>
        <a href="#" class="nav-btn">GALLERY</a>
        <a href="#" class="nav-btn">PROJECTS</a>
        <a href="#" class="nav-btn">ADMIN</a>
    </div>

    <div class="main-container" id="projectListView">
        <div class="project-header">
            <h1>VVCKD MUSIC ROOMS <span class="cursor">â–Œ</span></h1>
            <div class="project-subtitle">ENHANCED COLLABORATIVE MUSIC WORKSPACE</div>
        </div>

        <div class="add-project-section" id="addProjectSection">
            <h3 style="color: #ff6600; margin-bottom: 20px;">CREATE MUSIC ROOM</h3>
            <button class="add-btn" onclick="createMusicRoom()">+ CREATE ROOM</button>
        </div>

        <div class="project-grid" id="projectGrid">
        </div>
    </div>

    <!-- boombox.io ìŠ¤íƒ€ì¼ ìŒì•…ë£¸ í™”ë©´ -->
    <div class="music-room" id="musicRoomView">
        <div class="music-room-header">
            <div class="room-title" id="roomTitle">MUSIC ROOM</div>
            <button class="leave-btn" id="leaveRoomBtn">LEAVE ROOM</button>
        </div>
        <div class="music-content">
            <!-- ê°„ë‹¨í•œ íŠ¸ë™ ì •ë³´ (boombox.io ìŠ¤íƒ€ì¼) -->
            <div class="track-header-simple">
                <div class="track-info-left">
                    <div class="track-title-simple" id="currentTrackTitle">No track selected</div>
                    <div class="track-uploader-simple" id="currentTrackUploader">Upload a track to get started</div>
                </div>
                <div class="track-actions">
                    <button class="download-btn" id="downloadBtn" disabled>ğŸ“¥ DOWNLOAD</button>
                </div>
            </div>

            <!-- ë©”ì¸ ì›¨ì´ë¸Œí¼ ì˜ì—­ (boombox.io ìŠ¤íƒ€ì¼) -->
            <div class="waveform-main-area">
                <div class="waveform-container-main" id="waveformContainerMain">
                    <canvas class="waveform-canvas-main" id="waveformCanvasMain"></canvas>
                    <div class="waveform-progress-main" id="waveformProgressMain"></div>
                    <div class="playhead-main" id="playheadMain"></div>
                    <div class="waveform-loading-main" id="waveformLoadingMain">
                        ğŸµ Upload a track to see waveform<br>
                        Drag and drop or click upload button
                    </div>
                </div>

                <!-- ì‹œê°„ í‘œì‹œ (ì›¨ì´ë¸Œí¼ ë°”ë¡œ ì•„ë˜) -->
                <div class="time-display" id="timeDisplay">
                    <div>
                        <span class="time-current" id="currentTime">00:00</span>
                        <span class="time-separator">/</span>
                        <span class="time-total" id="totalTime">00:00</span>
                    </div>
                </div>

                <!-- ê°„ë‹¨í•œ ì»¨íŠ¸ë¡¤ (boombox.io ìŠ¤íƒ€ì¼) -->
                <div class="simple-controls">
                    <button class="play-btn-main" id="playBtnMain">â–¶</button>
                    <button class="upload-btn-main" id="uploadBtnMain">ğŸ“ UPLOAD MUSIC</button>
                </div>
            </div>

            <!-- ëŒ“ê¸€ ì„¹ì…˜ (ì›¨ì´ë¸Œí¼ ë°”ë¡œ ì•„ë˜, boombox.io ìŠ¤íƒ€ì¼) -->
            <div class="comments-section">
                <div class="comment-input-area">
                    <div class="comment-time-indicator" id="commentTimeIndicator">00:00</div>
                    <input type="text" class="comment-input" id="commentInput" placeholder="Add your comment here, mention users with @">
                    <button class="comment-btn voice" id="voiceBtn">ğŸ¤ VOICE</button>
                    <button class="comment-btn send" id="sendBtn">SEND</button>
                </div>
                <div class="comments-list" id="commentsList">
                    <!-- ì‹œìŠ¤í…œ ëŒ“ê¸€ ì œê±° - ë¹ˆ ìƒíƒœë¡œ ì‹œì‘ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ (ìˆ¨ê¹€) -->
    <audio id="audioPlayer" style="display: none;"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let socket;
        let currentUser = '';
        let userRole = 'guest';
        let musicRooms = [];
        let currentPlaylist = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        let audioPlayer;
        let currentRoomId = null;
        let audioContextInstance = null;

        // DOM ìš”ì†Œ ìºì‹±
        let currentUserSpan, userRoleSpan, loginModal, usernameInput, joinButton, projectListView, musicRoomView, projectGrid, leaveRoomBtn, playBtnMain, uploadBtnMain, commentInput, voiceBtn, sendBtn, commentsList, waveformContainerMain, waveformCanvasMain, waveformProgressMain, playheadMain, waveformLoadingMain, currentTrackTitle, currentTrackUploader, timeDisplay, currentTimeSpan, totalTimeSpan, downloadBtn, commentTimeIndicator;

        // í˜„ì¬ ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´
        let currentFile = null;
        let currentFileBlob = null;

        // ë°© ëª©ë¡ì„ ì €ì¥ (ë°ëª¨ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
        function saveMusicRoomsToStorage() {
            try {
                const roomsData = JSON.stringify(musicRooms);
                // ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì„œë²„ì— ì €ì¥
                console.log('ğŸ’¾ Music rooms data prepared for storage:', roomsData);
            } catch (error) {
                console.error('âŒ Failed to prepare rooms data:', error);
            }
        }

        // ë°© ëª©ë¡ ë¡œë“œ (ë°ëª¨ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
        function loadMusicRoomsFromStorage() {
            try {
                // ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì„œë²„ì—ì„œ ë¡œë“œ
                console.log('ğŸ“‚ Music rooms data would be loaded from server');
                return false;
            } catch (error) {
                console.error('âŒ Failed to load rooms data:', error);
            }
            return false;
        }

        // ì†Œì¼“ ì´ˆê¸°í™” (ì‹¤ì œ Socket.IO ì‚¬ìš©)
        function initializeSocket() {
            // Socket.IO ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
            if (typeof io === 'undefined') {
                const script = document.createElement('script');
                script.src = '/socket.io/socket.io.js';
                script.onload = function() {
                    connectSocket();
                };
                script.onerror = function() {
                    console.error('âŒ Socket.IO ë¡œë“œ ì‹¤íŒ¨, ë”ë¯¸ ì†Œì¼“ ì‚¬ìš©');
                    createDummySocket();
                };
                document.head.appendChild(script);
            } else {
                connectSocket();
            }
        }

        // ì‹¤ì œ Socket.IO ì—°ê²°
        function connectSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('âœ… Music: Connected to server');
                console.log('Socket ID:', socket.id);
            });

            socket.on('disconnect', () => {
                console.log('âŒ Music: Disconnected from server');
            });

            // ìŒì•… ë£¸ ê´€ë ¨ ì´ë²¤íŠ¸
            socket.on('music room list', function(rooms) {
                console.log('ğŸ“‹ Received music room list:', rooms);
                musicRooms = rooms;
                updateProjectGrid();
            });

            socket.on('music room created', function(room) {
                console.log('âœ… Music room created:', room);
                // ë°© ìƒì„± ì¦‰ì‹œ ëª©ë¡ì— ì¶”ê°€
                musicRooms.push(room);
                updateProjectGrid();
            });

            // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë°©ì„ ë§Œë“¤ì—ˆì„ ë•Œ ëª©ë¡ ì—…ë°ì´íŠ¸
            socket.on('music room list update', function() {
                console.log('ğŸ”„ Music room list update requested');
                loadMusicRooms();
            });

            socket.on('music room join success', function(data) {
                console.log('âœ… Successfully joined music room:', data);
                handleRoomJoinSuccess(data);
            });

            socket.on('music room join error', function(data) {
                console.log('âŒ Failed to join music room:', data);
                alert('ë°© ì…ì¥ ì‹¤íŒ¨: ' + data.message);
            });

            // ìŒì•… ë£¸ ì±„íŒ… ë©”ì‹œì§€
            socket.on('music chat message', function(data) {
                console.log('ğŸ“¨ Received music chat message:', data);
                if (data.roomId === currentRoomId) {
                    if (data.audioUrl) {
                        addVoiceCommentToDOM(data);
                    } else {
                        addCommentToDOM(data);
                    }
                }
            });

            console.log('ğŸµ Socket.IO initialized for music');
        }

        // ë”ë¯¸ ì†Œì¼“ (fallback)
        function createDummySocket() {
            const eventCallbacks = {};
            
            socket = {
                emit: function(event, data) {
                    console.log('ğŸ“¤ Dummy socket emit:', event, data);
                    
                    if (event === 'create music room') {
                        const newRoom = {
                            id: `room-${Date.now()}`,
                            name: data.roomName,
                            description: data.description || 'Collaborative music workspace',
                            genres: data.genres || ['Electronic', 'Hip-Hop', 'Rock'],
                            maxUsers: data.maxUsers || 10,
                            participants: 1,
                            musicCount: 0,
                            status: 'active'
                        };
                        musicRooms.push(newRoom);
                        updateProjectGrid(); // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                        console.log('âœ… Room created successfully:', newRoom);
                    }
                    
                    if (event === 'get music room list') {
                        console.log('ğŸ“‹ Current rooms:', musicRooms);
                        if (eventCallbacks['music room list']) {
                            eventCallbacks['music room list'](musicRooms);
                        }
                    }
                },
                
                on: function(event, callback) {
                    console.log('ğŸ‘‚ Dummy socket listener registered: ' + event);
                    eventCallbacks[event] = callback;
                    
                    if (event === 'music room list') {
                        setTimeout(function() {
                            console.log('ğŸ“¤ Sending room list:', musicRooms);
                            callback(musicRooms);
                        }, 100);
                    }
                }
            };
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        function login() {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                currentUserSpan.textContent = username;
                userRoleSpan.textContent = '[USER]';
                loginModal.style.display = 'none';
                
                console.log('âœ… User logged in:', username);
                loadMusicRooms();
            } else {
                alert('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìŒì•… ë£¸ ìƒì„± (ì‹¤ì œ ì„œë²„ ì—°ë™)
        function createMusicRoom() {
            if (!currentUser || currentUser === 'GUEST') {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const roomName = prompt('ìŒì•… ë£¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (roomName) {
                const roomData = {
                    roomName: roomName,
                    description: 'Collaborative music workspace',
                    genres: ['Electronic', 'Hip-Hop', 'Rock'],
                    maxUsers: 10,
                    type: 'music' // ìŒì•… ë£¸ì„ì„ êµ¬ë¶„
                };
                
                socket.emit('create music room', roomData);
                console.log('ğŸ  Creating music room:', roomName);
            }
        }

        // ìŒì•… ë£¸ ëª©ë¡ ë¡œë“œ (ì‹¤ì œ ì„œë²„ ì—°ë™)
        function loadMusicRooms() {
            console.log('ğŸ“‚ Loading music rooms from server');
            socket.emit('get music room list');
        }

        // ìŒì•… ë£¸ ì…ì¥ (ì‹¤ì œ ì„œë²„ ì—°ë™)
        function joinMusicRoom(roomId) {
            console.log('ğŸšª Joining music room:', roomId);
            socket.emit('join music room', { roomId: roomId });
        }

        // ìŒì•… ë£¸ ì…ì¥ (ì„œë²„ ì—°ë™)
        function joinMusicRoom(roomId) {
            console.log('ğŸšª Joining music room:', roomId);
            socket.emit('join music room', { roomId: roomId });
        }

        // ìŒì•… ë£¸ ì…ì¥ ì„±ê³µ ì²˜ë¦¬
        function handleRoomJoinSuccess(data) {
            projectListView.style.display = 'none';
            musicRoomView.style.display = 'flex';
            
            // í˜„ì¬ ë°© ID ì €ì¥
            currentRoomId = data.roomId;
            
            const room = musicRooms.find(r => r.id === data.roomId);
            if (room) {
                document.getElementById('roomTitle').textContent = room.name;
            }
            
            // ì±„íŒ… ë‚´ìš© ë³µì›
            restoreChatMessages(data.roomId);
        }

        // ì±„íŒ… ë‚´ìš©ì„ ì €ì¥ (ë°ëª¨ìš©)
        function saveChatToStorage(roomId, chatData) {
            try {
                // ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì„œë²„ì— ì €ì¥
                console.log('ğŸ’¾ Chat data prepared for storage:', roomId, chatData);
            } catch (error) {
                console.error('âŒ Failed to prepare chat data:', error);
            }
        }

        // ì±„íŒ… ë‚´ìš© ë¡œë“œ (ë°ëª¨ìš©)
        function loadChatFromStorage(roomId) {
            try {
                // ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì„œë²„ì—ì„œ ë¡œë“œ
                console.log('ğŸ“‚ Chat data would be loaded from server for room:', roomId);
                return [];
            } catch (error) {
                console.error('âŒ Failed to load chat data:', error);
            }
            return [];
        }

        // ì±„íŒ… ëª©ë¡ ë³µì›
        function restoreChatMessages(roomId) {
            // ê¸°ì¡´ ëª¨ë“  ë©”ì‹œì§€ ì œê±° (ì‹œìŠ¤í…œ ë©”ì‹œì§€ í¬í•¨)
            commentsList.innerHTML = '';
            
            const savedChats = loadChatFromStorage(roomId);
            // ì €ì¥ëœ ì±„íŒ… ë³µì›
            savedChats.forEach(chat => {
                if (chat.audioUrl) {
                    addVoiceCommentToDOM(chat);
                } else {
                    addCommentToDOM(chat);
                }
            });
            
            if (savedChats.length > 0) {
                console.log('ğŸ”„ Restored', savedChats.length, 'chat messages for room:', roomId);
            }
        }

        // ìŒì•… ë£¸ ë‚˜ê°€ê¸° (ì„œë²„ ì—°ë™)
        function leaveMusicRoom() {
            console.log('ğŸšª Leaving music room');
            
            if (currentRoomId) {
                socket.emit('leave music room', { roomId: currentRoomId });
                currentRoomId = null;
            }
            
            musicRoomView.style.display = 'none';
            projectListView.style.display = 'block';
            
            // ì˜¤ë””ì˜¤ ì •ì§€
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                isPlaying = false;
                if (playBtnMain) {
                    playBtnMain.textContent = 'â–¶';
                }
            }
            
            // íŒŒì¼ ì •ë³´ ì´ˆê¸°í™”
            currentFile = null;
            currentFileBlob = null;
            
            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'ğŸ“¥ DOWNLOAD';
            }
            
            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì •ë¦¬
            if (audioContextInstance) {
                audioContextInstance.close();
                audioContextInstance = null;
            }
            
            // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            loadMusicRooms();
        }

        // ëŒ“ê¸€ ì „ì†¡ (ì„œë²„ ì—°ë™)
        function sendComment() {
            const message = commentInput.value.trim();
            if (message && currentUser && currentUser !== 'GUEST' && currentRoomId) {
                const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
                
                const commentData = {
                    roomId: currentRoomId,
                    user: currentUser,
                    message: message,
                    timestamp: timestamp,
                    time: new Date().toISOString()
                };
                
                socket.emit('music chat message', commentData);
                commentInput.value = '';
                console.log('ğŸ’¬ Comment sent:', commentData);
            } else if (!currentUser || currentUser === 'GUEST') {
                alert('ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìŒì„± ë©”ì‹œì§€ ì „ì†¡ (ì„œë²„ ì—°ë™)
        function sendVoiceMessage(audioBlob) {
            if (!currentRoomId) return;
            
            const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // ìŒì„± ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡
            const voiceData = {
                roomId: currentRoomId,
                user: currentUser,
                timestamp: timestamp,
                audioUrl: audioUrl, // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì— ì—…ë¡œë“œ í•„ìš”
                time: new Date().toISOString()
            };
            
            socket.emit('music voice message', voiceData);
            console.log('ğŸ¤ Voice message sent:', voiceData);
        }

        // ëŒ“ê¸€ ì¶”ê°€
        function addComment(user, message, timestamp) {
            const chatData = {
                user: user,
                message: message,
                timestamp: timestamp,
                time: new Date().toISOString()
            };
            
            // ì €ì¥
            if (currentRoomId) {
                saveChatToStorage(currentRoomId, chatData);
            }
            
            // DOMì— ì¶”ê°€
            addCommentToDOM(chatData);
        }

        // DOMì— ëŒ“ê¸€ ì¶”ê°€ (ë³µì›ìš©)
        function addCommentToDOM(chatData) {
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <span class="comment-user">${chatData.user}</span>
                    <span class="comment-timestamp" onclick="seekToTime(${chatData.timestamp})">[${formatTime(chatData.timestamp)}]</span>
                </div>
                <div class="comment-text">${chatData.message}</div>
            `;
            
            commentsList.appendChild(commentItem);
            // ìŠ¤í¬ë¡¤ ì œê±° - ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥ë˜ë„ë¡
        }

        // DOMì— ìŒì„± ëŒ“ê¸€ ì¶”ê°€ (ë³µì›ìš©)
        function addVoiceCommentToDOM(chatData) {
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item voice-comment';
            
            commentItem.innerHTML = `
                <div class="comment-header">
                    <span class="comment-user">${chatData.user}</span>
                    <span class="comment-timestamp" onclick="seekToTime(${chatData.timestamp})">[${formatTime(chatData.timestamp)}]</span>
                </div>
                <div class="voice-message">
                    ğŸ¤ Voice Message
                    <audio controls style="width: 100%; margin-top: 5px;">
                        <source src="${chatData.audioUrl}" type="audio/wav">
                    </audio>
                </div>
            `;
            
            commentsList.appendChild(commentItem);
            // ìŠ¤í¬ë¡¤ ì œê±° - ìì—°ìŠ¤ëŸ½ê²Œ í™•ì¥ë˜ë„ë¡
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ (ì œê±°ë¨)
        // function addTimestamp() {
        //     if (!currentUser || currentUser === 'GUEST') {
        //         alert('ë¡œê·¸ì¸ í›„ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        //         return;
        //     }
        //     const currentTime = audioPlayer ? audioPlayer.currentTime : 0;
        //     const message = `[Timestamp at ${formatTime(currentTime)}]`;
        //     addComment(currentUser, message, currentTime);
        // }

        // ì‹œê°„ í¬ë§· í•¨ìˆ˜
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // íŠ¹ì • ì‹œê°„ìœ¼ë¡œ ì´ë™
        function seekToTime(time) {
            if (audioPlayer && audioPlayer.duration) {
                audioPlayer.currentTime = time;
                console.log('ğŸµ Seeked to: ' + formatTime(time));
            }
        }

        // ì›¨ì´ë¸Œí¼ í´ë¦­ ì²˜ë¦¬
        function handleWaveformClick(event) {
            if (audioPlayer && audioPlayer.duration) {
                const rect = waveformContainerMain.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const newTime = percentage * audioPlayer.duration;
                seekToTime(newTime);
            }
        }

        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸
        function updateAudioPlayer() {
            if (audioPlayer && !isNaN(audioPlayer.currentTime)) {
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration || 0;
                
                // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = formatTime(currentTime);
                }
                if (totalTimeSpan && duration > 0) {
                    totalTimeSpan.textContent = formatTime(duration);
                }
                
                // ëŒ“ê¸€ ì…ë ¥ ì˜ì—­ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (commentTimeIndicator) {
                    commentTimeIndicator.textContent = formatTime(currentTime);
                }
                
                // ì›¨ì´ë¸Œí¼ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    
                    // ì›¨ì´ë¸Œí¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                    updateWaveformProgress(progressPercent);
                    
                    // í”Œë ˆì´í—¤ë“œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    if (playheadMain) {
                        playheadMain.style.left = `${progressPercent}%`;
                    }
                }
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(file) {
            if (file && file.type.startsWith('audio/')) {
                // í˜„ì¬ íŒŒì¼ ì •ë³´ ì €ì¥
                currentFile = file;
                currentFileBlob = file;
                
                const fileUrl = URL.createObjectURL(file);
                audioPlayer.src = fileUrl;
                
                currentTrackTitle.textContent = file.name;
                currentTrackUploader.textContent = `Uploaded by: ${currentUser}`;
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'ğŸ“¥ DOWNLOAD';
                }
                
                // ì—…ë¡œë“œ í›„ ìº”ë²„ìŠ¤ í‘œì‹œ ë° ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
                waveformLoadingMain.style.display = 'none';
                waveformCanvasMain.style.display = 'block';
                
                // ì‹œê°„ í‘œì‹œ ì´ˆê¸°í™”
                if (currentTimeSpan) {
                    currentTimeSpan.textContent = '00:00';
                }
                if (totalTimeSpan) {
                    totalTimeSpan.textContent = '00:00';
                }
                
                // ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹œ ì´ ì‹œê°„ ì—…ë°ì´íŠ¸
                audioPlayer.addEventListener('loadedmetadata', function() {
                    if (totalTimeSpan) {
                        totalTimeSpan.textContent = formatTime(audioPlayer.duration);
                    }
                });
                
                // ì›¨ì´ë¸Œí¼ ìƒì„±
                generateWaveform(file);
                
                console.log('âœ… Audio file loaded:', file.name);
            }
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        function downloadCurrentFile() {
            if (!currentFile || !currentFileBlob) {
                alert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const downloadUrl = URL.createObjectURL(currentFileBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = downloadUrl;
                downloadLink.download = currentFile.name;
                downloadLink.style.display = 'none';
                
                // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                // URL ì •ë¦¬
                setTimeout(() => {
                    URL.revokeObjectURL(downloadUrl);
                }, 100);
                
                console.log('âœ… File download initiated:', currentFile.name);
            } catch (error) {
                console.error('âŒ Download failed:', error);
                alert('ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì›¨ì´ë¸Œí¼ ìƒì„± í•¨ìˆ˜
        function generateWaveform(file) {
            try {
                audioContextInstance = new (window.AudioContext || window.webkitAudioContext)();
                const canvas = waveformCanvasMain;
                const ctx = canvas.getContext('2d');
                
                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    audioContextInstance.decodeAudioData(e.target.result)
                        .then((audioBuffer) => {
                            drawWaveform(ctx, audioBuffer, canvas.width, canvas.height);
                        })
                        .catch((error) => {
                            console.error('âŒ Error decoding audio:', error);
                            // ì—ëŸ¬ ì‹œ ë”ë¯¸ ì›¨ì´ë¸Œí¼ í‘œì‹œ
                            drawDummyWaveform(ctx, canvas.width, canvas.height);
                        });
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('âŒ Error creating audio context:', error);
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨ ì‹œ ë”ë¯¸ ì›¨ì´ë¸Œí¼ í‘œì‹œ
                const canvas = waveformCanvasMain;
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                drawDummyWaveform(ctx, canvas.width, canvas.height);
            }
        }

        // ì›¨ì´ë¸Œí¼ ë°ì´í„° ì €ì¥ìš© ë³€ìˆ˜
        let waveformData = null;

        // ì‹¤ì œ ì›¨ì´ë¸Œí¼ ê·¸ë¦¬ê¸° (boombox.io ìŠ¤íƒ€ì¼)
        function drawWaveform(ctx, audioBuffer, width, height) {
            const data = audioBuffer.getChannelData(0);
            const step = Math.ceil(data.length / width);
            const amp = height / 2;
            
            // ì›¨ì´ë¸Œí¼ ë°ì´í„° ì €ì¥
            waveformData = {
                data: data,
                step: step,
                amp: amp,
                width: width,
                height: height
            };
            
            // ë°°ê²½ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì •
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // ì›¨ì´ë¸Œí¼ ê·¸ë¦¬ê¸° - ì´ˆê¸°ì—ëŠ” ëª¨ë‘ íšŒìƒ‰
            drawWaveformWithProgress(ctx, 0);
            
            console.log('âœ… boombox.io style waveform generated');
        }

        // ì§„í–‰ë¥ ì— ë”°ë¼ ì›¨ì´ë¸Œí¼ ê·¸ë¦¬ê¸°
        function drawWaveformWithProgress(ctx, progressPercent) {
            if (!waveformData) return;
            
            const { data, step, amp, width, height } = waveformData;
            const centerY = height / 2;
            const progressPixel = (progressPercent / 100) * width;
            
            // ë°°ê²½ ì§€ìš°ê¸°
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            // ì›¨ì´ë¸Œí¼ ê·¸ë¦¬ê¸°
            for (let i = 0; i < width; i += 1) {
                let min = 1.0;
                let max = -1.0;
                
                for (let j = 0; j < step; j++) {
                    const datum = data[(i * step) + j];
                    if (datum < min) min = datum;
                    if (datum > max) max = datum;
                }
                
                // ë°” ë†’ì´ ê³„ì‚°
                const barHeight = Math.max(1, Math.abs(max - min) * amp * 0.9);
                
                // ì¬ìƒ ìœ„ì¹˜ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
                if (i <= progressPixel) {
                    ctx.fillStyle = '#00ff00'; // ì¬ìƒëœ ë¶€ë¶„ - ë…¹ìƒ‰
                } else {
                    ctx.fillStyle = '#666'; // ì•„ì§ ì¬ìƒë˜ì§€ ì•Šì€ ë¶€ë¶„ - íšŒìƒ‰
                }
                
                // ì›¨ì´ë¸Œí¼ ë°” ê·¸ë¦¬ê¸°
                ctx.fillRect(i, centerY - barHeight/2, 1, barHeight);
            }
        }

        // ì§„í–‰ë¥ ì— ë”°ë¼ ì›¨ì´ë¸Œí¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        function updateWaveformProgress(progressPercent) {
            const canvas = waveformCanvasMain;
            const ctx = canvas.getContext('2d');
            
            if (!canvas || !ctx) return;
            
            // ì›¨ì´ë¸Œí¼ì„ ì§„í–‰ë¥ ì— ë”°ë¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            drawWaveformWithProgress(ctx, progressPercent);
        }

        // ë”ë¯¸ ì›¨ì´ë¸Œí¼ ê·¸ë¦¬ê¸° (boombox.io ìŠ¤íƒ€ì¼)
        function drawDummyWaveform(ctx, width, height) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            const centerY = height / 2;
            
            // ë”ë¯¸ ì›¨ì´ë¸Œí¼ ë°ì´í„° ìƒì„±
            const dummyData = [];
            for (let i = 0; i < width; i += 2) {
                dummyData.push(Math.random() * 0.8 - 0.4);
            }
            
            // ì›¨ì´ë¸Œí¼ ë°ì´í„° ì €ì¥
            waveformData = {
                isDummy: true,
                dummyData: dummyData,
                width: width,
                height: height
            };
            
            // boombox.io ìŠ¤íƒ€ì¼ì˜ ë”ë¯¸ ì›¨ì´ë¸Œí¼ - íšŒìƒ‰ìœ¼ë¡œ ì‹œì‘
            for (let i = 0; i < width; i += 2) {
                const barHeight = Math.random() * height * 0.6 + 4;
                
                // ê¸°ë³¸ íšŒìƒ‰ ì›¨ì´ë¸Œí¼
                ctx.fillStyle = '#666';
                ctx.fillRect(i, centerY - barHeight/2, 1, barHeight);
            }
            
            console.log('âœ… boombox.io style dummy waveform generated');
        }

        // í”„ë¡œì íŠ¸ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
        function updateProjectGrid() {
            if (musicRooms.length === 0) {
                projectGrid.innerHTML = `
                    <div class="project-card" style="text-align: center; padding: 40px;">
                        <div style="color: #888; margin-bottom: 20px;">No rooms available</div>
                        <div style="color: #666; font-size: 8px;">Create the first music room to get started!</div>
                        <button class="project-btn" disabled>EMPTY</button>
                    </div>
                `;
                return;
            }

            projectGrid.innerHTML = '';
            
            musicRooms.forEach(function(room) {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                
                projectCard.innerHTML = `
                    <div class="project-title">
                        ${room.name}
                        <span class="project-status status-${room.status}">${room.status.toUpperCase()}</span>
                    </div>
                    <div class="project-info">
                        <span class="project-participants">ğŸ‘¥ ${room.participants} users</span>
                        <span class="project-music-count">ğŸµ ${room.musicCount} tracks</span>
                    </div>
                    <div class="project-description">${room.description}</div>
                    <div class="project-tech">
                        <span class="tech-tag">AUDIO</span>
                        <span class="tech-tag">COLLABORATION</span>
                        <span class="tech-tag">REAL-TIME</span>
                        <span class="tech-tag">VOICE MEMO</span>
                    </div>
                    <div class="project-links">
                        <button class="project-btn join" onclick="joinMusicRoom('${room.id}')">JOIN ROOM</button>
                        <button class="project-btn" onclick="viewRoomInfo('${room.id}')">VIEW INFO</button>
                    </div>
                `;
                
                projectGrid.appendChild(projectCard);
            });
        }

        // ë£¸ ì •ë³´ ë³´ê¸°
        function viewRoomInfo(roomId) {
            const room = musicRooms.find(r => r.id === roomId);
            if (room) {
                alert(`Room: ${room.name}\nDescription: ${room.description}\nParticipants: ${room.participants}/${room.maxUsers}\nTracks: ${room.musicCount}`);
            }
        }

        // ìŒì„± ë…¹ìŒ ê´€ë ¨ ë³€ìˆ˜
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        // ìŒì„± ë…¹ìŒ ì‹œì‘
        function startVoiceRecording() {
            if (!currentUser || currentUser === 'GUEST') {
                alert('ë¡œê·¸ì¸ í›„ ìŒì„± ë©”ì‹œì§€ë¥¼ ë…¹ìŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    // ë…¹ìŒ ë°ì´í„° ìˆ˜ì§‘
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    // ë…¹ìŒ ì™„ë£Œ ì‹œ ëŒ“ê¸€ë¡œ ì „ì†¡
                    mediaRecorder.onstop = function() {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        sendVoiceMessage(blob);
                        
                        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.textContent = 'â¹ï¸ STOP';
                    voiceBtn.style.background = '#ff0000';
                    console.log('ğŸ¤ Voice recording started');
                })
                .catch(function(error) {
                    console.error('âŒ Voice recording error:', error);
                    alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                });
        }

        // ìŒì„± ë…¹ìŒ ì¤‘ì§€
        function stopVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.textContent = 'ğŸ¤ VOICE';
                voiceBtn.style.background = 'transparent';
                console.log('ğŸ¤ Voice recording stopped');
            }
        }
        
        // ìŒì„± ë©”ì‹œì§€ ì „ì†¡
        function sendVoiceMessage(audioBlob) {
            const timestamp = audioPlayer ? audioPlayer.currentTime : 0;
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // ìŒì„± ë©”ì‹œì§€ë¥¼ ëŒ“ê¸€ë¡œ ì¶”ê°€
            const comment = {
                user: currentUser,
                timestamp: timestamp,
                text: '[ìŒì„± ë©”ì‹œì§€]',
                audioUrl: audioUrl,
                time: new Date().toLocaleTimeString()
            };
            
            addVoiceCommentToDOM(comment);
            console.log('ğŸ¤ Voice message sent successfully');
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeApp() {
            console.log('ğŸµ VVCKD Music System initialized');
            
            // DOM ìš”ì†Œë“¤ ì´ˆê¸°í™”
            currentUserSpan = document.getElementById('currentUser');
            userRoleSpan = document.getElementById('userRole');
            loginModal = document.getElementById('loginModal');
            usernameInput = document.getElementById('usernameInput');
            joinButton = document.getElementById('joinButton');
            projectListView = document.getElementById('projectListView');
            musicRoomView = document.getElementById('musicRoomView');
            projectGrid = document.getElementById('projectGrid');
            leaveRoomBtn = document.getElementById('leaveRoomBtn');
            playBtnMain = document.getElementById('playBtnMain');
            uploadBtnMain = document.getElementById('uploadBtnMain');
            commentInput = document.getElementById('commentInput');
            voiceBtn = document.getElementById('voiceBtn');
            sendBtn = document.getElementById('sendBtn');
            commentsList = document.getElementById('commentsList');
            waveformContainerMain = document.getElementById('waveformContainerMain');
            waveformCanvasMain = document.getElementById('waveformCanvasMain');
            waveformProgressMain = document.getElementById('waveformProgressMain');
            playheadMain = document.getElementById('playheadMain');
            waveformLoadingMain = document.getElementById('waveformLoadingMain');
            currentTrackTitle = document.getElementById('currentTrackTitle');
            currentTrackUploader = document.getElementById('currentTrackUploader');
            audioPlayer = document.getElementById('audioPlayer');
            timeDisplay = document.getElementById('timeDisplay');
            currentTimeSpan = document.getElementById('currentTime');
            totalTimeSpan = document.getElementById('totalTime');
            downloadBtn = document.getElementById('downloadBtn');
            commentTimeIndicator = document.getElementById('commentTimeIndicator');

            // ì†Œì¼“ ì´ˆê¸°í™”
            initializeSocket();

            // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì œ ì—°ê²° ì‹œì—ë§Œ ë“±ë¡)
            if (typeof io !== 'undefined') {
                // ìŒì•… ë£¸ ì…ì¥ ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
                socket.on('music room join success', handleRoomJoinSuccess);
            } else {
                // ë”ë¯¸ ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                socket.on('music room list', function(rooms) {
                    console.log('ğŸ“‹ Received room list:', rooms);
                    musicRooms = rooms;
                    updateProjectGrid();
                });
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            setupEventListeners();

            // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
            if (loginModal) {
                loginModal.style.display = 'flex';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ë¡œê·¸ì¸ ì´ë²¤íŠ¸
            if (joinButton) {
                joinButton.addEventListener('click', login);
            }
            
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // ë£¸ ë‚˜ê°€ê¸° ì´ë²¤íŠ¸
            if (leaveRoomBtn) {
                leaveRoomBtn.addEventListener('click', leaveMusicRoom);
            }
            
            // ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (playBtnMain) {
                playBtnMain.addEventListener('click', function() {
                    if (audioPlayer && audioPlayer.src) {
                        if (isPlaying) {
                            audioPlayer.pause();
                            this.textContent = 'â–¶';
                            isPlaying = false;
                        } else {
                            audioPlayer.play();
                            this.textContent = 'â¸';
                            isPlaying = true;
                        }
                    }
                });
            }

            // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (uploadBtnMain) {
                uploadBtnMain.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'audio/*';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            handleFileUpload(file);
                        }
                    };
                    input.click();
                });
            }

            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
            if (audioPlayer) {
                audioPlayer.addEventListener('timeupdate', updateAudioPlayer);
                audioPlayer.addEventListener('ended', () => {
                    isPlaying = false;
                    if (playBtnMain) {
                        playBtnMain.textContent = 'â–¶';
                    }
                });
            }

            // ì›¨ì´ë¸Œí¼ í´ë¦­ ì‹œ íƒìƒ‰
            if (waveformContainerMain) {
                waveformContainerMain.addEventListener('click', handleWaveformClick);
                
                // íŒŒì¼ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
                waveformContainerMain.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });

                waveformContainerMain.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileUpload(files[0]);
                    }
                });
            }

            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadCurrentFile);
            }

            // ëŒ“ê¸€ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            if (sendBtn) {
                sendBtn.addEventListener('click', sendComment);
            }

            if (commentInput) {
                commentInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendComment();
                    }
                });
            }

            if (voiceBtn) {
                voiceBtn.addEventListener('click', function() {
                    if (isRecording) {
                        stopVoiceRecording();
                    } else {
                        startVoiceRecording();
                    }
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
